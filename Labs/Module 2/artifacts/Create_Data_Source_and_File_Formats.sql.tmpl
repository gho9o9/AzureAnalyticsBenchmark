
USE TPCDSDBDemo
GO

IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.call_center') DROP VIEW TPCDS.call_center
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.catalog_page') DROP VIEW TPCDS.catalog_page
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.catalog_returns') DROP VIEW TPCDS.catalog_returns
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.catalog_sales') DROP VIEW TPCDS.catalog_sales
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.customer') DROP VIEW TPCDS.customer
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.customer_address') DROP VIEW TPCDS.customer_address
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.customer_demographics') DROP VIEW TPCDS.customer_demographics
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.date_dim') DROP VIEW TPCDS.date_dim
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.household_demographics') DROP VIEW TPCDS.household_demographics
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.income_band') DROP VIEW TPCDS.income_band
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.inventory') DROP VIEW TPCDS.inventory
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.item') DROP VIEW TPCDS.item
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.promotion') DROP VIEW TPCDS.promotion
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.reason') DROP VIEW TPCDS.reason
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.ship_mode') DROP VIEW TPCDS.ship_mode
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.store') DROP VIEW TPCDS.store
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.store_returns') DROP VIEW TPCDS.store_returns
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.store_sales') DROP VIEW TPCDS.store_sales
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.time_dim') DROP VIEW TPCDS.time_dim
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.warehouse') DROP VIEW TPCDS.warehouse
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_page') DROP VIEW TPCDS.web_page
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_returns') DROP VIEW TPCDS.web_returns
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_sales') DROP VIEW TPCDS.web_sales
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'VIEW' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_site') DROP VIEW TPCDS.web_site
GO
DROP EXTERNAL FILE FORMAT [FF_Parquet]
GO
DROP EXTERNAL DATA SOURCE [TPCDataSource]
GO
DROP DATABASE SCOPED CREDENTIAL [SasADLSDemoDatabaseScoped]
GO
DROP MASTER KEY
GO


IF NOT EXISTS (SELECT 1 FROM sys.symmetric_keys WHERE symmetric_key_id = 101)
BEGIN
	CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'REPLACE_PASSWORD';
END
GO

CREATE DATABASE SCOPED CREDENTIAL [SasADLSDemoDatabaseScoped]
WITH IDENTITY = 'SHARED ACCESS SIGNATURE',
     SECRET = 'REPLACE_SAS'
GO

CREATE EXTERNAL DATA SOURCE [TPCDataSource] WITH (
    LOCATION = 'https://REPLACE_STORAGE.blob.core.windows.net/data', CREDENTIAL = [SasADLSDemoDatabaseScoped]
);
GO

CREATE EXTERNAL FILE FORMAT [FF_Parquet] WITH (
    FORMAT_TYPE = PARQUET,
    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'
);
GO

