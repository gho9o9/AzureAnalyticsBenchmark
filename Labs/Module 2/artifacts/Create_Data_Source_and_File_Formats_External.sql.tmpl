

USE TPCDSDBExternal
GO

IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.call_center') DROP EXTERNAL TABLE TPCDS.call_center
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.catalog_page') DROP EXTERNAL TABLE TPCDS.catalog_page
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.catalog_returns') DROP EXTERNAL TABLE TPCDS.catalog_returns
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.catalog_sales') DROP EXTERNAL TABLE TPCDS.catalog_sales
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.customer') DROP EXTERNAL TABLE TPCDS.customer
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.customer_address') DROP EXTERNAL TABLE TPCDS.customer_address
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.customer_demographics') DROP EXTERNAL TABLE TPCDS.customer_demographics
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.date_dim') DROP EXTERNAL TABLE TPCDS.date_dim
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.household_demographics') DROP EXTERNAL TABLE TPCDS.household_demographics
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.income_band') DROP EXTERNAL TABLE TPCDS.income_band
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.inventory') DROP EXTERNAL TABLE TPCDS.inventory
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.item') DROP EXTERNAL TABLE TPCDS.item
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.promotion') DROP EXTERNAL TABLE TPCDS.promotion
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.reason') DROP EXTERNAL TABLE TPCDS.reason
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.ship_mode') DROP EXTERNAL TABLE TPCDS.ship_mode
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.store') DROP EXTERNAL TABLE TPCDS.store
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.store_returns') DROP EXTERNAL TABLE TPCDS.store_returns
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.store_sales') DROP EXTERNAL TABLE TPCDS.store_sales
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.time_dim') DROP EXTERNAL TABLE TPCDS.time_dim
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.warehouse') DROP EXTERNAL TABLE TPCDS.warehouse
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_page') DROP EXTERNAL TABLE TPCDS.web_page
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_returns') DROP EXTERNAL TABLE TPCDS.web_returns
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_sales') DROP EXTERNAL TABLE TPCDS.web_sales
IF EXISTS (SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE' AND CONCAT(TABLE_SCHEMA, '.', TABLE_NAME) = 'TPCDS.web_site') DROP EXTERNAL TABLE TPCDS.web_site
GO
DROP EXTERNAL FILE FORMAT [FF_Parquet]
GO
DROP EXTERNAL DATA SOURCE [TPCDataSource]
GO
DROP DATABASE SCOPED CREDENTIAL [SasADLSDemoDatabaseScoped]
GO
DROP MASTER KEY
GO

IF NOT EXISTS (SELECT 1 FROM sys.symmetric_keys WHERE symmetric_key_id = 101)
BEGIN
	CREATE MASTER KEY ENCRYPTION BY PASSWORD = 'REPLACE_PASSWORD';
END
GO

CREATE DATABASE SCOPED CREDENTIAL [SasADLSDemoDatabaseScoped]
WITH IDENTITY = 'SHARED ACCESS SIGNATURE',
     SECRET = 'REPLACE_SAS'
GO

CREATE EXTERNAL DATA SOURCE [TPCDataSource] WITH (
    LOCATION = 'https://REPLACE_STORAGE.blob.core.windows.net/data', CREDENTIAL = [SasADLSDemoDatabaseScoped]
);
GO

CREATE EXTERNAL FILE FORMAT [FF_Parquet] WITH (
    FORMAT_TYPE = PARQUET,
    DATA_COMPRESSION = 'org.apache.hadoop.io.compress.SnappyCodec'
);
GO
